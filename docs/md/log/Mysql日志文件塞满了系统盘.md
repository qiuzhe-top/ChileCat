# 后台未知BUG导致请求超时

Created: January 4, 2022 6:23 PM

### 问题描述

问题首次发生于2022/1/3 22:30左右，解决与4号下午

大概花了一两小时解决，差点耽误了我做饭时间哈哈。

不是特别大的问题，只是排查的时候不容易关注到

其中很奇怪的是那天晚上是gg了，但是当我第二天起床的时候发现它居然好了(早起身体棒)

然后一直到下午又gg了，然后下午的时候我重新启动了，后台服务(uwsgi),居然又好了，看来重启解决90的问题，但不到10分钟，他们又过来跟我说挂了。

所以在下午3点左右正式开始排查。

首先错误情况 我只有这一张图，说服务504 请求超时。

![](images/Untitled-16414568691147.png)

然后我又查看了我多个前端项目发现均可以打开，但是都不能与后台交互，但是可以首先排除nginx代理服务是没有问题的。

然后我就去尝试重启后台服务

```bash
killall -9 uwsgi
```

因为我只有一个后台所以直接杀死即可，然后重新启动

```bash
source /project/pyChileCat/bin/activate
uwsgi -x ChileCat.xml
```

主要是这两句命令，进入虚拟环境，启动服务。

### 尝试重启

然后我每次重新启动都失败了，在重启这个步骤上我花了大约20来分钟时间，为什么花这么多时间来重新启动，是因为以前经常会出现有问题然后重启就好了，而且有时候重启一次两次不行，得多重启几次，我透了，我把这称之为“玄学”。但这次操作让我明白了，大部分玄学其实是自己没学到位，去他的玄学，但是我还是相信玄学，嘿嘿 真香。

### 查看uwsgi日志

因为后台是uwsgi启动的，那么查看它的日志肯定能够有所发现

然后我把日志下载下来， 我得乖乖这么大日志了。(我这几百人的小程序)

![Untitled](images/Untitled%201.png)

好吧其实我程序本身就没写输出日志的操作，因为程序体量不大，而且也没有规范日志。所以在这个日志里面没有得到重要的信息，因为它也没有报错。

### 线上排除程序本身

但是到这里我还是没有得到任何有效信息，只有我关掉uwsgi后，nginx提示说找不到服务，然后开启后，就是超时，结合日志也没有错误信息，理论上是不会有问题的。但是程序本身是不是出现bug这个必须检验一次。

理论上程序不动是不会出现问题的，谁家代码又会自己改哪 哈！

但是我才写了几年代码纳 哪来这个自信纳 😂 😂😂 😂😂 😂

所以我直接

```bash
git fetch --all &&  git reset --hard origin/master && git pull
```

强制把在线仓库里面的代码覆盖到本地

经过几次玄学的重启，他**，居然还是不行 🤮🤮🤮🤮 吐了

然后我有去服务器上面用测试命令启动项目

```bash
python [manage.py](http://manage.py/) runserver 0.0.0.0:8600
```

![Untitled](images/Untitled%202.png)

哈哈我的程序果然没有bug

然后我又高兴的去玄学重启了几分钟，发现****，居然还是不行 🤮🤮🤮🤮 吐了，我还急着烧晚饭纳。看看时间都4点左右了。

测试启动没问题，但是部署启动就没效果，真是难搞。

后面我突然想起去访问一下这个测试服务看看，果然在浏览器里面访问失败，一直转圈，也不报错。就很离谱

### 本地调试

没办法，这个情况很明显程序是出错误了，只能在本地进行调试了，然后我在本地打开项目，发现就跟上了飞机跑道

这就头痛了，同样的代码，线上就是不行，而且线上也没有具体报错提示就一直超时。

一到线下就飞起，呵呵

但是线上环境毕竟和本地环境不一样，只能继续测试了，然后我只能继续测试，一刹那 我突发奇想，我的项目并没有依赖过多的第三方平台，只使用了一个mysql数据库。好家伙，我立马用本地项目去连接线上mysql，😄😄😄😄😄😄我

透了，果然项目正常启动但就是，访问超时，果然是线上数据库问题，然后我又用本地mysql可视化管理工具进行连接，哎还是跟德福巧克力一样。数据一切正常。

这就奇怪了呀，没办法，我去服务器上面把mysql查了一遍，查了配置，端口，访问权限一切正常。

这。。。我能想到的只有重启了

### 排查Mysql

没办法，配置均正常，那就只能重新启动了

```bash
systemctl restart mysql
```

![Untitled](images/Untitled%203-16414559663411.png)

啊 这居然报错了，那我就查看了一下MySQL状态

```bash
systemctl status mysqld.service
```

![Untitled](images/Untitled%204-16414559860842.png)

我去亲爱的朋友 上面写了几个大字  没有空间了？？？？？？？？？？？？？？？？？？？？？？？

然后我去看了眼阿里的面板

![Untitled](images/Untitled%205-16414560200683.png)

哈哈哈 这就离谱

### 解决方案

解决方案就简单说了

1. 单独启用一个学生机
2. 安装docker
3. 下载启动mysql8.x.x 具体版本
4. 迁移旧的数据
5. 现有后台连接新的数据库

完成

大公告成

开始做饭

### 问题定位

经过排查可以发现mysql占了极大空间

![Untitled](images/Untitled%206-16414560324274.png)

![Untitled](images/Untitled%207-16414560467355.png)

而mysql里面是这样的一个日志文件占用了极大空间 [binlog的描述](https://blog.csdn.net/weixin_43944305/article/details/108620849)

### 解决方法

我直接删除了所有日志，然后把这个功能关闭了，再重启服务

```bash
vi /etc/my.cnf

log_bin=OFF
disable_log_bin=OFF
```

可以这样验证结果

![Untitled](images/Untitled%208-16414560698936.png)